<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pago Exitoso - Merch Shop</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header class="header">
        <div class="logo">Merch Shop</div>
        <div class="icons">
            <a href="/">
                <button title="Ir al inicio">
                    <i class="fas fa-home"></i>
                </button>
            </a>
        </div>
    </header>

    <main class="main">
        <div class="success-container">
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h1>¡Pago Exitoso!</h1>
                <div id="loadingMessage" class="success-message">
                    <i class="fas fa-spinner fa-spin"></i>
                    Procesando tu pago...
                </div>
                
                <div id="successContent" class="success-message" style="display: none;">
                    <p>Tu pago ha sido procesado exitosamente. ¡Gracias por tu compra!</p>
                    
                    <div class="payment-details" id="paymentDetails">
                        <!-- Payment details will be loaded here -->
                    </div>
                </div>
                
                <div class="success-actions">
                    <a href="/" class="btn-primary">
                        <i class="fas fa-home"></i> Volver al inicio
                    </a>
                    <a href="/artistas" class="btn-secondary">
                        <i class="fas fa-music"></i> Ver más productos
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://0ec90b57d6e95fcbda19832f.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJib2x0IiwicmVmIjoiMGVjOTBiNTdkNmU5NWZjYmRhMTk4MzJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4ODE1NzQsImV4cCI6MTc1ODg4MTU3NH0.9I8-U0x86Ak8t2DGaIk0HfvTSLsAyzdnz-Nw00mMkKw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            
            if (!sessionId) {
                showError('No se encontró información de la sesión de pago');
                return;
            }

            try {
                // Check if user is authenticated
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showError('Debes iniciar sesión para ver los detalles del pago');
                    return;
                }

                // Wait a moment for webhook processing
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Check subscription status
                const { data: subscription, error: subError } = await supabase
                    .from('stripe_user_subscriptions')
                    .select('*')
                    .maybeSingle();

                // Check orders
                const { data: orders, error: orderError } = await supabase
                    .from('stripe_user_orders')
                    .select('*')
                    .order('order_date', { ascending: false })
                    .limit(1);

                let paymentType = 'unknown';
                let details = '';

                if (subscription && subscription.subscription_status === 'active') {
                    paymentType = 'subscription';
                    details = `
                        <div class="payment-info">
                            <h3>Suscripción Activada</h3>
                            <p><strong>Estado:</strong> Activa</p>
                            <p><strong>Próximo pago:</strong> ${new Date(subscription.current_period_end * 1000).toLocaleDateString('es-AR')}</p>
                        </div>
                    `;
                } else if (orders && orders.length > 0) {
                    const order = orders[0];
                    paymentType = 'payment';
                    details = `
                        <div class="payment-info">
                            <h3>Compra Completada</h3>
                            <p><strong>Monto:</strong> $${(order.amount_total / 100).toFixed(2)} ${order.currency.toUpperCase()}</p>
                            <p><strong>Estado:</strong> ${order.payment_status}</p>
                            <p><strong>Fecha:</strong> ${new Date(order.order_date).toLocaleDateString('es-AR')}</p>
                        </div>
                    `;
                }

                showSuccess(details);

            } catch (error) {
                console.error('Error processing payment success:', error);
                showError('Error al procesar la información del pago');
            }
        });

        function showSuccess(details) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('successContent').style.display = 'block';
            document.getElementById('paymentDetails').innerHTML = details;
        }

        function showError(message) {
            document.getElementById('loadingMessage').innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            `;
        }
    </script>
</body>

</html>